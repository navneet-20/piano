<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glass Piano App</title>
    
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiR2xhc3MgUGlhbm8iLCJzaG9ydF9uYW1lIjoiUGlhbm8iLCJzdGFydF91cmwiOiIuIiwidGhlbWVfY29xvciIjM4YmRmOCIsImJhY2tncm91bmRfY29sb3IiOiIjMGUxNzJhIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJvcmllbnRhdGlvbiI6ImxhbmRzY2FwZSIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8yOTAzLzI5MDMyODkucG5nIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJdfQ=='>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#38bdf8">

    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            --glass-bg: rgba(30, 41, 59, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(12px);
            --accent: #38bdf8;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            height: 100vh;
            background: var(--bg-gradient);
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            user-select: none;
            touch-action: none; /* Disables browser zooming/scrolling */
        }

        /* --- UI CONTAINER --- */
        .studio-container {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 98%;
            max-width: 900px;
            height: 95vh;
        }

        /* --- HEADER --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; height: 40px; }
        h1 { margin: 0; font-weight: 300; letter-spacing: 1px; font-size: 1.1rem; color: var(--accent); }

        .app-btn {
            background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: white;
            padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer;
        }
        .app-btn:active { background: var(--accent); color: black; }

        /* --- CONTROLS GRID (Scrollable on small phones) --- */
        .controls-wrapper {
            flex: 1;
            overflow-y: auto;
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .panel {
            background: rgba(255,255,255,0.03);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .panel-title { font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted); font-weight: bold; }

        /* SLIDERS & BUTTONS */
        input[type=range] { width: 100%; accent-color: var(--accent); height: 4px; }
        select { background: #0f172a; color: white; border: 1px solid #334155; padding: 4px; border-radius: 4px; width: 100%; font-size: 0.8rem;}
        
        button.ctrl-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main);
            padding: 8px; border-radius: 6px; width: 100%; font-size: 0.75rem; cursor: pointer;
        }
        button.ctrl-btn:active { background: rgba(255,255,255,0.2); transform: scale(0.98); }
        button.active-toggle { background: var(--accent); color: #000; border-color: var(--accent); }

        /* SONG LIBRARY BUTTONS */
        .song-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .song-btn { background: rgba(56, 189, 248, 0.1); border: 1px solid var(--accent); color: var(--accent); padding: 6px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }
        .song-btn:active { background: var(--accent); color: #000; }

        /* --- PIANO (FLEXIBLE HEIGHT) --- */
        .piano-wrapper {
            flex: 2; /* Takes up more space */
            position: relative;
            display: flex;
            justify-content: center;
            min-height: 150px;
        }

        .piano { display: flex; position: relative; width: 100%; height: 100%; }

        .key {
            position: relative;
            flex: 1; /* Auto width */
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 15px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 0 0 8px 8px;
            user-select: none;
            touch-action: none;
        }

        .key.white {
            background: #e2e8f0; color: #334155; margin: 0 1px; z-index: 1;
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1);
        }
        .key.white.active { background: var(--accent); color: #000; transform: scale(0.95); transform-origin: top; }

        .key.black {
            background: #0f172a; color: #94a3b8; width: 60%; 
            margin-left: -30%; margin-right: -30%; /* Overlap logic */
            z-index: 2; height: 60%; /* Shorter than white */
            box-shadow: 2px 4px 8px rgba(0,0,0,0.4);
            border: 1px solid #334155; border-top: none;
            pointer-events: auto; /* Ensure black keys capture touch */
        }
        /* Black key sizing logic for flexbox is tricky, using absolute positioning for black keys relative to white might be better, 
           but the visual trick of negative margins works if we explicitly handle z-index in touch logic */
        
        .key.black.active { background: var(--accent); color: #fff; transform: scale(0.95); transform-origin: top; }
        .key span { pointer-events: none; opacity: 0.5; margin-bottom: 5px; }

        /* --- OVERLAY --- */
        #overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s; cursor: pointer; text-align: center; padding: 20px;
        }
        #overlay h1 { font-size: 2.5rem; color: var(--accent); margin-bottom: 10px; }
        #overlay p { color: #ccc; font-size: 1rem; margin-bottom: 30px; }
        .install-hint { font-size: 0.8rem; color: #666; border: 1px dashed #444; padding: 10px; border-radius: 8px; max-width: 300px;}
    </style>
</head>
<body>

    <div id="overlay">
        <h1>GLASS PIANO</h1>
        <p>Tap to Start Engine</p>
        <div class="install-hint">
            <strong>To Install as App:</strong><br>
            iOS: Share → Add to Home Screen<br>
            Android: Chrome Menu → Install App
        </div>
    </div>

    <div class="studio-container">
        
        <div class="top-bar">
            <h1>Mobile Studio</h1>
            <button class="app-btn" id="btn-fs">Fullscreen</button>
        </div>

        <div class="controls-wrapper">
            <div class="controls">
                
                <div class="panel">
                    <div class="panel-title">Song Library</div>
                    <div class="song-grid">
                        <button class="song-btn" onclick="playSong('birthday')">Birthday</button>
                        <button class="song-btn" onclick="playSong('love')">I Love You</button>
                        <button class="song-btn" onclick="playSong('joy')">Ode to Joy</button>
                        <button class="song-btn" onclick="stopSong()">⏹ Stop</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">Sound</div>
                    <select id="waveform">
                        <option value="triangle">Triangle (Soft)</option>
                        <option value="sawtooth" selected>Sawtooth (Rich)</option>
                        <option value="square">Square (8-Bit)</option>
                        <option value="sine">Sine (Pure)</option>
                    </select>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <button class="ctrl-btn" id="btn-oct-down">- Oct</button>
                        <span id="oct-disp" style="padding:5px; font-weight:bold;">4</span>
                        <button class="ctrl-btn" id="btn-oct-up">+ Oct</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">Recorder</div>
                    <div style="display:flex; gap:5px;">
                        <button class="ctrl-btn" id="btn-rec" style="color:#ef4444;">● Rec</button>
                        <button class="ctrl-btn" id="btn-stop">■</button>
                        <button class="ctrl-btn" id="btn-play">▶</button>
                    </div>
                    <div id="status" style="font-size:0.7rem; color:#64748b; margin-top:5px; text-align:center;">Ready</div>
                </div>

                <div class="panel">
                    <div class="panel-title">FX</div>
                    <div style="display:flex; align-items:center; gap:5px; font-size:0.7rem;">
                        <span>Rev</span>
                        <input type="range" id="reverb" max="1" step="0.1" value="0.3">
                    </div>
                    <button class="ctrl-btn" id="btn-sustain" style="margin-top:5px;">Sustain: Off</button>
                </div>

            </div>
        </div>

        <div class="piano-wrapper">
            <div class="piano" id="piano">
                <div class="key white" data-note="C" data-key="z"><span>C</span></div>
                <div class="key black" data-note="C#" data-key="s"></div>
                <div class="key white" data-note="D" data-key="x"><span>D</span></div>
                <div class="key black" data-note="D#" data-key="d"></div>
                <div class="key white" data-note="E" data-key="c"><span>E</span></div>
                <div class="key white" data-note="F" data-key="v"><span>F</span></div>
                <div class="key black" data-note="F#" data-key="g"></div>
                <div class="key white" data-note="G" data-key="b"><span>G</span></div>
                <div class="key black" data-note="G#" data-key="h"></div>
                <div class="key white" data-note="A" data-key="n"><span>A</span></div>
                <div class="key black" data-note="A#" data-key="j"></div>
                <div class="key white" data-note="B" data-key="m"><span>B</span></div>
                <div class="key white" data-note="C2" data-key=","><span>C2</span></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & SONGS ---
        const config = {
            baseFreq: {
                "C": 261.63, "C#": 277.18, "D": 293.66, "D#": 311.13,
                "E": 329.63, "F": 349.23, "F#": 369.99, "G": 392.00,
                "G#": 415.30, "A": 440.00, "A#": 466.16, "B": 493.88, "C2": 523.25
            },
            waveform: 'sawtooth',
            vol: 0.2,
            reverb: 0.3,
            octave: 0,
            sustain: false
        };

        const songs = {
            birthday: [
                {n:'G', d:200, w:300}, {n:'G', d:200, w:600}, {n:'A', d:400, w:1000}, {n:'G', d:400, w:1500}, {n:'C2', d:400, w:2000}, {n:'B', d:800, w:2500},
                {n:'G', d:200, w:3300}, {n:'G', d:200, w:3600}, {n:'A', d:400, w:4000}, {n:'G', d:400, w:4500}, {n:'D', d:400, w:5000, oct:1}, {n:'C2', d:800, w:5500}
            ],
            love: [
                {n:'G', d:400, w:0}, {n:'E', d:400, w:500}, {n:'G', d:400, w:1000},
                {n:'G', d:400, w:1500}, {n:'E', d:400, w:2000}, {n:'G', d:400, w:2500},
                {n:'A', d:400, w:3000}, {n:'G', d:400, w:3500}, {n:'F', d:400, w:4000}, {n:'E', d:400, w:4500}, {n:'D', d:800, w:5000},
                {n:'E', d:400, w:6000}, {n:'F', d:400, w:6500}, {n:'E', d:400, w:7000}, {n:'D', d:400, w:7500}, {n:'C', d:800, w:8000}
            ],
            joy: [
                {n:'E', d:300, w:0}, {n:'E', d:300, w:350}, {n:'F', d:300, w:700}, {n:'G', d:300, w:1050},
                {n:'G', d:300, w:1400}, {n:'F', d:300, w:1750}, {n:'E', d:300, w:2100}, {n:'D', d:300, w:2450},
                {n:'C', d:300, w:2800}, {n:'C', d:300, w:3150}, {n:'D', d:300, w:3500}, {n:'E', d:300, w:3850},
                {n:'E', d:400, w:4200}, {n:'D', d:100, w:4700}, {n:'D', d:800, w:4900}
            ]
        };

        let audioCtx, masterGain, reverbNode, songTimeouts = [];
        let isInit = false;
        let lastTouchedKey = null;

        // Recording
        let recordedEvents = [];
        let startTime = 0;
        let isRecording = false;

        // --- 2. AUDIO ENGINE ---
        function initAudio() {
            if(isInit) return;
            const Actx = window.AudioContext || window.webkitAudioContext;
            audioCtx = new Actx();
            
            masterGain = audioCtx.createGain();
            masterGain.connect(audioCtx.destination);
            
            // Reverb
            reverbNode = audioCtx.createConvolver();
            reverbNode.buffer = createImpulse(audioCtx);
            const revGain = audioCtx.createGain();
            revGain.gain.value = config.reverb;
            
            masterGain.connect(reverbNode);
            reverbNode.connect(revGain);
            revGain.connect(audioCtx.destination);

            isInit = true;
            document.getElementById('overlay').style.opacity = '0';
            setTimeout(()=>document.getElementById('overlay').remove(), 500);
        }

        function createImpulse(ctx) {
            const len = ctx.sampleRate * 2;
            const buf = ctx.createBuffer(2, len, ctx.sampleRate);
            for(let i=0; i<len; i++) {
                const v = (Math.random()*2-1) * Math.pow(1-i/len, 3);
                buf.getChannelData(0)[i] = v;
                buf.getChannelData(1)[i] = v;
            }
            return buf;
        }

        function playNote(note, duration=null, forceOct=null) {
            if(!isInit) return;
            
            const oct = forceOct !== null ? forceOct : config.octave;
            const freq = config.baseFreq[note] * Math.pow(2, oct);

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = config.waveform;
            osc.frequency.value = freq;
            
            osc.connect(gain);
            gain.connect(masterGain);
            
            const now = audioCtx.currentTime;
            osc.start(now);
            
            // Release Logic
            const sustainTime = duration ? duration/1000 : (config.sustain ? 1.5 : 0.5);
            
            gain.gain.setValueAtTime(config.vol, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + sustainTime);
            osc.stop(now + sustainTime);

            // Record
            if(isRecording) {
                recordedEvents.push({note:note, time:Date.now()-startTime, oct:oct, sets:{...config}});
            }

            // Visual
            const key = document.querySelector(`.key[data-note="${note}"]`);
            if(key) {
                key.classList.add('active');
                setTimeout(()=>key.classList.remove('active'), 150);
            }
        }

        // --- 3. MOBILE TOUCH LOGIC (GLISSANDO) ---
        const pianoEl = document.getElementById('piano');

        function handleTouch(e) {
            e.preventDefault(); // Stop scroll
            // Handle multiple fingers
            for(let i=0; i < e.changedTouches.length; i++) {
                const t = e.changedTouches[i];
                const el = document.elementFromPoint(t.clientX, t.clientY);
                
                if(el && el.classList.contains('key')) {
                    // Only play if it's a new key press or entering a new key
                    if(el !== lastTouchedKey || e.type === 'touchstart') {
                        playNote(el.dataset.note);
                        lastTouchedKey = el;
                    }
                }
            }
        }
        
        // Reset last key on end
        pianoEl.addEventListener('touchend', () => lastTouchedKey = null);
        pianoEl.addEventListener('touchstart', handleTouch, {passive: false});
        pianoEl.addEventListener('touchmove', handleTouch, {passive: false});
        
        // Mouse for PC
        let isMouseDown = false;
        pianoEl.addEventListener('mousedown', (e) => {
            isMouseDown = true;
            if(e.target.classList.contains('key')) playNote(e.target.dataset.note);
        });
        pianoEl.addEventListener('mouseup', () => isMouseDown = false);
        pianoEl.addEventListener('mouseover', (e) => {
            if(isMouseDown && e.target.classList.contains('key')) playNote(e.target.dataset.note);
        });

        // --- 4. SONG PLAYER ---
        window.playSong = function(name) {
            if(!isInit) initAudio();
            stopSong();
            const data = songs[name];
            data.forEach(evt => {
                const t = setTimeout(() => {
                    playNote(evt.n, evt.d, evt.oct || 0);
                }, evt.w);
                songTimeouts.push(t);
            });
        };

        window.stopSong = function() {
            songTimeouts.forEach(clearTimeout);
            songTimeouts = [];
        };

        // --- 5. UI & UTILS ---
        document.getElementById('overlay').addEventListener('click', initAudio);
        document.getElementById('btn-fs').onclick = () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        };

        // Octave
        const updateOct = (d) => {
            config.octave = Math.max(-2, Math.min(2, config.octave + d));
            document.getElementById('oct-disp').innerText = 4 + config.octave;
        };
        document.getElementById('btn-oct-up').onclick = () => updateOct(1);
        document.getElementById('btn-oct-down').onclick = () => updateOct(-1);
        
        // Sound
        document.getElementById('waveform').onchange = e => config.waveform = e.target.value;
        document.getElementById('reverb').oninput = e => config.reverb = parseFloat(e.target.value);
        
        // Sustain
        const btnSus = document.getElementById('btn-sustain');
        btnSus.onclick = () => {
            config.sustain = !config.sustain;
            btnSus.innerText = config.sustain ? "Sustain: ON" : "Sustain: Off";
            btnSus.classList.toggle('active-toggle');
        };

        // Recorder
        const btnRec = document.getElementById('btn-rec');
        const status = document.getElementById('status');
        btnRec.onclick = () => {
            recordedEvents = [];
            isRecording = true;
            startTime = Date.now();
            status.innerText = "Recording...";
            btnRec.classList.add('active-toggle');
        };
        document.getElementById('btn-stop').onclick = () => {
            isRecording = false;
            btnRec.classList.remove('active-toggle');
            status.innerText = `Saved ${recordedEvents.length} notes`;
        };
        document.getElementById('btn-play').onclick = () => {
            if(!recordedEvents.length) return;
            status.innerText = "Playing Recording...";
            recordedEvents.forEach(evt => {
                setTimeout(() => playNote(evt.note, null, evt.oct), evt.time);
            });
        };

    </script>
</body>
</html>
